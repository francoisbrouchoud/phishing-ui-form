<div class="app-container">
  <mat-card class="url-card">
    <mat-card-title>{{ title }}</mat-card-title>
    <mat-card-subtitle>
      Entrez une URL pour extraire les caractéristiques, modifiez-les si besoin,
      puis interrogez le modèle Dataiku.
    </mat-card-subtitle>

    <mat-card-content>
      <form (ngSubmit)="analyze()" class="url-form">
        <mat-form-field appearance="outline" class="url-input">
          <mat-label>URL à analyser</mat-label>

          <input
            matInput
            type="text"
            [formControl]="urlControl"
            placeholder="https://exemple.com/login?user=123"
          />

          @if (urlControl.value) {
            <button
              matSuffix
              mat-icon-button
              type="button"
              aria-label="Effacer"
              (click)="clearUrl()
            ">
              <mat-icon>clear</mat-icon>
            </button>
          }

          @if (urlControl.hasError('required') && urlControl.touched) {
            <mat-error>L'URL est obligatoire.</mat-error>
          }
        </mat-form-field>

        <div class="buttons-row">
          <!-- Étape 1 : analyse -->
          <button mat-raised-button color="primary" type="submit">
            Analyser
          </button>

          <!-- Étape 2 : prédiction -->
          <button
            mat-raised-button
            color="accent"
            type="button"
            (click)="predict()"
            [disabled]="!features || isLoadingPrediction"
          >
            @if (!isLoadingPrediction) {
              <span>Prédire (Dataiku)</span>
            } @else {
              <span>Prédiction en cours…</span>
            }
          </button>
        </div>
      </form>

      @if (errorMessage) {
        <div class="error-message">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <span>{{ errorMessage }}</span>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Features extraites (éditables) -->
  @if (features; as f) {
    <mat-accordion class="features-accordion">
      <mat-expansion-panel [expanded]="true">
        <mat-expansion-panel-header>
          <mat-panel-title>Features extraites (éditables)</mat-panel-title>
          <mat-panel-description>
            URLLength: {{ f.URLLength }} • Domain: {{ f.Domain }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <table class="features-table">
          <tbody>
            <!-- URL & domaine -->
            <tr>
              <td class="feature-name">URL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="text"
                    name="URL"
                    [(ngModel)]="features!.URL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">URLLength</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="URLLength"
                    [(ngModel)]="features!.URLLength"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">Domain</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="text"
                    name="Domain"
                    [(ngModel)]="features!.Domain"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">DomainLength</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="DomainLength"
                    [(ngModel)]="features!.DomainLength"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">TLD</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="text"
                    name="TLD"
                    [(ngModel)]="features!.TLD"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">TLDLength</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="TLDLength"
                    [(ngModel)]="features!.TLDLength"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">NoOfSubDomain</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfSubDomain"
                    [(ngModel)]="features!.NoOfSubDomain"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">IsDomainIP</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="IsDomainIP"
                    [(ngModel)]="features!.IsDomainIP"
                  />
                </mat-form-field>
              </td>
            </tr>

            <!-- Comptages -->
            <tr>
              <td class="feature-name">NoOfLettersInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfLettersInURL"
                    [(ngModel)]="features!.NoOfLettersInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">NoOfDegitsInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfDegitsInURL"
                    [(ngModel)]="features!.NoOfDegitsInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <!-- Ratios -->
            <tr>
              <td class="feature-name">LetterRatioInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    step="0.0001"
                    name="LetterRatioInURL"
                    [(ngModel)]="features!.LetterRatioInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">DegitRatioInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    step="0.0001"
                    name="DegitRatioInURL"
                    [(ngModel)]="features!.DegitRatioInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">CharContinuationRate</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    step="0.0001"
                    name="CharContinuationRate"
                    [(ngModel)]="features!.CharContinuationRate"
                  />
                </mat-form-field>
              </td>
            </tr>

            <!-- Autres compteurs -->
            <tr>
              <td class="feature-name">NoOfQMarkInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfQMarkInURL"
                    [(ngModel)]="features!.NoOfQMarkInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">NoOfEqualsInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfEqualsInURL"
                    [(ngModel)]="features!.NoOfEqualsInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">NoOfAmpersandInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfAmpersandInURL"
                    [(ngModel)]="features!.NoOfAmpersandInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">NoOfOtherSpecialCharsInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    name="NoOfOtherSpecialCharsInURL"
                    [(ngModel)]="features!.NoOfOtherSpecialCharsInURL"
                  />
                </mat-form-field>
              </td>
            </tr>

            <tr>
              <td class="feature-name">SpecialCharRatioInURL</td>
              <td class="feature-value">
                <mat-form-field appearance="outline" class="feature-field">
                  <input
                    matInput
                    type="number"
                    step="0.0001"
                    name="SpecialCharRatioInURL"
                    [(ngModel)]="features!.SpecialCharRatioInURL"
                  />
                </mat-form-field>
              </td>
            </tr>
          </tbody>
        </table>
      </mat-expansion-panel>
    </mat-accordion>
  }

  @if (predictionResult; as p) {
    <mat-accordion class="features-accordion prediction-accordion">
      <mat-expansion-panel [expanded]="true">
        <mat-expansion-panel-header>
          <mat-panel-title>Résultat du modèle Dataiku</mat-panel-title>
          <mat-panel-description>
            Prediction: {{ p.prediction }} • Percentile:
            {{ p.probaPercentile }}%
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="prediction-block">
          <h3>Prediction</h3>
          <p>
            <strong>Classe prédite :</strong> {{ p.prediction }}
          </p>
          <p>
            <strong>Percentile de probabilité :</strong>
            {{ p.probaPercentile }} %
          </p>
          <p>
            <strong>Ignoré :</strong> {{ p.ignored ? 'Oui' : 'Non' }}
          </p>

          <h3>Probabilités</h3>
          <ul class="proba-list">
            @if (getProba('0') !== null) {
              <li>
                Classe 0 :
                {{ getProba('0')! | percent: '1.2-2' }}
              </li>
            }
            @if (getProba('1') !== null) {
              <li>
                Classe 1 :
                {{ getProba('1')! | percent: '1.2-2' }}
              </li>
            }
          </ul>

         

          <h3>Réponse brute</h3>
          <pre>{{ { result: p } | json }}</pre>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  }
</div>
