<div class="app-container">
  <!-- Carte saisie URL -->
  <mat-card class="url-card">
    <mat-card-title>{{ title }}</mat-card-title>
    <mat-card-subtitle>
      Entrez une URL pour extraire les caractéristiques, modifiez-les si besoin
      puis interrogez le modèle Dataiku.
    </mat-card-subtitle>

    <mat-card-content>
      <form (ngSubmit)="analyze()" class="url-form">
        <mat-form-field appearance="outline" class="url-input">
          <mat-label>URL à analyser</mat-label>
          <input
            matInput
            type="text"
            [formControl]="urlControl"
            placeholder="https://exemple.com/login?user=123"
          />
          <button
            *ngIf="urlControl.value"
            matSuffix
            mat-icon-button
            type="button"
            aria-label="Effacer"
            (click)="clearUrl()"
          >
            <mat-icon>clear</mat-icon>
          </button>
          <mat-error *ngIf="urlControl.hasError('required')">
            L'URL est obligatoire.
          </mat-error>
        </mat-form-field>

        <div class="buttons-row">
          <!-- Étape 1 : analyse -->
          <button mat-raised-button color="primary" type="submit">
            Analyser
          </button>

          <!-- Étape 2 : prédiction -->
          <button
            mat-raised-button
            color="accent"
            type="button"
            (click)="predict()"
            [disabled]="!features || isLoadingPrediction"
          >
            <ng-container *ngIf="!isLoadingPrediction; else loadingTpl">
              Prédire (Dataiku)
            </ng-container>
          </button>
        </div>

        <ng-template #loadingTpl> Prédiction en cours… </ng-template>
      </form>

      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Features extraites (éditables) -->
  <mat-accordion *ngIf="features as f" class="features-accordion">
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Features extraites (éditables)</mat-panel-title>
        <mat-panel-description>
          URLLength: {{ f.URLLength }} • Domain: {{ f.Domain }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <table class="features-table">
        <tbody>
          <!-- URL & domaine -->
          <tr>
            <td class="feature-name">URL</td>
            <td class="feature-value">
              <input
                type="text"
                [(ngModel)]="features!.URL"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">URLLength</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.URLLength"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">Domain</td>
            <td class="feature-value">
              <input
                type="text"
                [(ngModel)]="features!.Domain"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">DomainLength</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.DomainLength"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">TLD</td>
            <td class="feature-value">
              <input
                type="text"
                [(ngModel)]="features!.TLD"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">TLDLength</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.TLDLength"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">NoOfSubDomain</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.NoOfSubDomain"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">IsDomainIP</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.IsDomainIP"
                class="feature-input"
              />
            </td>
          </tr>

          <!-- Comptages -->
          <tr>
            <td class="feature-name">NoOfLettersInURL</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.NoOfLettersInURL"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">NoOfDegitsInURL</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.NoOfDegitsInURL"
                class="feature-input"
              />
            </td>
          </tr>
          

          <!-- Ratios -->
          <tr>
            <td class="feature-name">LetterRatioInURL</td>
            <td class="feature-value">
              <input
                type="number"
                step="0.0001"
                [(ngModel)]="features!.LetterRatioInURL"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">DegitRatioInURL</td>
            <td class="feature-value">
              <input
                type="number"
                step="0.0001"
                [(ngModel)]="features!.DegitRatioInURL"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">CharContinuationRate</td>
            <td class="feature-value">
              <input
                type="number"
                step="0.0001"
                [(ngModel)]="features!.CharContinuationRate"
                class="feature-input"
              />
            </td>
          </tr>

          <!-- Autres compteurs -->
          <tr>
            <td class="feature-name">NoOfQMarkInURL</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.NoOfQMarkInURL"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">NoOfEqualsInURL</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.NoOfEqualsInURL"
                class="feature-input"
              />
            </td>
          </tr>
          <tr>
            <td class="feature-name">NoOfAmpersandInURL</td>
            <td class="feature-value">
              <input
                type="number"
                [(ngModel)]="features!.NoOfAmpersandInURL"
                class="feature-input"
              />
            </td>
          </tr>
        </tbody>
      </table>
    </mat-expansion-panel>
  </mat-accordion>

  <!-- Résultat Dataiku -->
  <mat-accordion
    *ngIf="predictionResult as p"
    class="features-accordion"
    style="margin-top: 16px"
  >
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>Résultat du modèle Dataiku</mat-panel-title>
        <mat-panel-description>
          Prediction: {{ p.prediction }} • Percentile:
          {{ p.probaPercentile }}%
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="prediction-block">
        <h3>Prediction</h3>
        <p>
          <strong>Classe prédite :</strong> {{ p.prediction }}
        </p>
        <p>
          <strong>Percentile de probabilité :</strong>
          {{ p.probaPercentile }} %
        </p>
        <p>
          <strong>Ignoré :</strong> {{ p.ignored ? 'Oui' : 'Non' }}
        </p>

        <h3>Probabilités</h3>
        <ul class="proba-list">
          <li *ngIf="getProba('0') !== null">
            Classe 0 :
            {{ getProba('0')! | percent: '1.2-2' }}
          </li>
          <li *ngIf="getProba('1') !== null">
            Classe 1 :
            {{ getProba('1')! | percent: '1.2-2' }}
          </li>
        </ul>

        <ng-container *ngIf="predictionTiming as t">
          <h3>Timings (ms)</h3>
          <table class="features-table">
            <tbody>
              <tr>
                <td class="feature-name">preProcessing</td>
                <td class="feature-value">{{ t.preProcessing }}</td>
              </tr>
              <tr>
                <td class="feature-name">wait</td>
                <td class="feature-value">{{ t.wait }}</td>
              </tr>
              <tr>
                <td class="feature-name">enrich</td>
                <td class="feature-value">{{ t.enrich }}</td>
              </tr>
              <tr>
                <td class="feature-name">preparation</td>
                <td class="feature-value">{{ t.preparation }}</td>
              </tr>
              <tr>
                <td class="feature-name">prediction</td>
                <td class="feature-value">{{ t.prediction }}</td>
              </tr>
              <tr>
                <td class="feature-name">postProcessing</td>
                <td class="feature-value">
                  {{ t.postProcessing }}
                </td>
              </tr>
            </tbody>
          </table>
        </ng-container>

        <h3>Réponse brute</h3>
        <pre>{{ { result: p, timing: predictionTiming } | json }}</pre>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>
