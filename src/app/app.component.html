<div class="app-shell">
  <mat-toolbar color="primary" class="app-toolbar mat-elevation-z4">
    <mat-icon class="toolbar-icon">security</mat-icon>
    <span class="app-toolbar-title">Phishing URL Detection</span>
  </mat-toolbar>

  <main class="app-main">
    <div class="app-container">

      <mat-card class="hero-card mat-elevation-z3">
        <mat-card-header>
          <mat-card-title>Analyseur d'URL</mat-card-title>
          <mat-card-subtitle>Entrez une URL pour extraire les features et interroger l'API Dataiku.</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content class="hero-content">
          <form (ngSubmit)="analyze()" class="url-form">
            <div class="input-wrapper">
              <mat-form-field appearance="outline" class="url-input" subscriptSizing="dynamic">
                <mat-label>URL cible</mat-label>
                <mat-icon matPrefix>link</mat-icon>
                <input matInput type="text" [formControl]="urlControl" placeholder="https://..." />
                
                @if (urlControl.value) {
                  <button matSuffix mat-icon-button type="button" (click)="clearUrl()" aria-label="Clear">
                    <mat-icon>close</mat-icon>
                  </button>
                }
                @if (urlControl.hasError('required') && urlControl.touched) {
                  <mat-error>L'URL est requise</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="actions-container">

  <div class="security-selector">
    <span class="label">Sensibilité :</span>
    <mat-button-toggle-group [(ngModel)]="securityLevel" name="securityLevel" aria-label="Niveau de sécurité" hideSingleSelectionIndicator>
      
      <mat-button-toggle [value]="0" matTooltip="Tolérant : Moins d'alertes">
        <mat-icon class="toggle-icon">gpp_maybe</mat-icon>
        <span>Bas</span>
      </mat-button-toggle>

      <mat-button-toggle [value]="1" matTooltip="Recommandé">
        <mat-icon class="toggle-icon">verified_user</mat-icon>
        <span>Normal</span>
      </mat-button-toggle>

      <mat-button-toggle [value]="2" matTooltip="Strict : Détection maximale">
        <mat-icon class="toggle-icon">lock</mat-icon>
        <span>Haut</span>
      </mat-button-toggle>

    </mat-button-toggle-group>
  </div>

  <div class="model-selector">
    <span class="label">Modèle API :</span>
    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="model-select">
      <mat-select [(ngModel)]="selectedApiModel" name="apiModel">
        <mat-option *ngFor="let m of apiModels" [value]="m.value">
          {{ m.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="buttons-group">
    <button mat-stroked-button color="primary" type="submit">
      <mat-icon>manage_search</mat-icon>
      1. Extraire
    </button>

    <button mat-flat-button color="accent" type="button" (click)="predict()" 
            [disabled]="!features || isLoadingPrediction">
      @if (isLoadingPrediction) {
        <mat-spinner diameter="20"></mat-spinner>
      } @else {
        <span class="btn-content-wrapper">
          <mat-icon>model_training</mat-icon>
          <span>2. Prédire</span>
        </span>
      }
    </button>
  </div>

</div>
          </form>

          @if (errorMessage) {
            <div class="alert-box error">
              <mat-icon>error</mat-icon>
              <span>{{ errorMessage }}</span>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <div class="dashboard-grid">
        
        @if (features; as f) {
          <mat-card class="features-card mat-elevation-z2">
            <mat-card-header>
              <div mat-card-avatar><mat-icon>tune</mat-icon></div>
              <mat-card-title>Features Extraites</mat-card-title>
              <mat-card-subtitle>Vous pouvez modifier les valeurs avant la prédiction</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="features-grid-full">
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>URL Normalisée</mat-label>
                  <input matInput [(ngModel)]="f.URL" name="URL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Domain</mat-label>
                  <input matInput [(ngModel)]="f.Domain" name="Domain">
                </mat-form-field>
              </div>

              <mat-divider class="spacer"></mat-divider>
              <h3 class="section-label">Structure & Longueurs</h3>
              
              <div class="features-grid-compact">
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>URL Length</mat-label>
                  <input matInput type="number" [(ngModel)]="f.URLLength">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Domain Length</mat-label>
                  <input matInput type="number" [(ngModel)]="f.DomainLength">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>TLD</mat-label>
                  <input matInput [(ngModel)]="f.TLD">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>TLD Length</mat-label>
                  <input matInput type="number" [(ngModel)]="f.TLDLength">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb of SubDomains</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfSubDomain">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Is IP?</mat-label>
                  <input matInput type="number" [(ngModel)]="f.IsDomainIP">
                </mat-form-field>
              </div>

              <h3 class="section-label">Caractères Spéciaux & Ratios</h3>
              <div class="features-grid-compact">
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb Letters</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfLettersInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb Degits</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfDegitsInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb '?'</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfQMarkInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb '='</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfEqualsInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb '&'</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfAmpersandInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Nb other spec. char</mat-label>
                  <input matInput type="number" [(ngModel)]="f.NoOfOtherSpecialCharsInURL">
                </mat-form-field>

                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Ratio letters</mat-label>
                  <input matInput type="number" step="0.001" [(ngModel)]="f.LetterRatioInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Ratio degits</mat-label>
                  <input matInput type="number" step="0.001" [(ngModel)]="f.DegitRatioInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Ratio spec. char</mat-label>
                  <input matInput type="number" step="0.001" [(ngModel)]="f.SpacialCharRatioInURL">
                </mat-form-field>
                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Char contin. rate</mat-label>
                  <input matInput type="number" step="0.001" [(ngModel)]="f.CharContinuationRate">
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>
        }

        @if (predictionResult; as p) {
          <div class="results-column">
            <mat-card class="result-card mat-elevation-z4" 
          [class.phishing]="isPhishing" 
          [class.safe]="!isPhishing">
              <mat-card-header>
                <mat-card-title>Résultat de la classification</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="verdict-badge">
                  @if (!isPhishing) {
                    <mat-icon class="icon-lg">verified_user</mat-icon>
                    <span class="verdict-text">URL LÉGITIME (Probable)</span>
                  } @else {
                    <mat-icon class="icon-lg">warning</mat-icon>
                    <span class="verdict-text">PHISHING DÉTECTÉ</span>
                  }
                </div>

                <div class="stats-box">
                  <div class="stat-row">
                    <span>Percentile</span>
                    <strong>{{ p.probaPercentile }}%</strong>
                  </div>
                  
                  <div class="proba-bars">
                    <div class="proba-item">
                      <span class="label">Phishing (0)</span>
                      <mat-progress-bar mode="determinate" [value]="(getProba('0') || 0) * 100" color="warn"></mat-progress-bar>
                      <span class="value">{{ getProba('0')! | percent:'1.1-2' }}</span>
                    </div>
                    <div class="proba-item">
                      <span class="label">Légitime (1)</span>
                      <mat-progress-bar mode="determinate" [value]="(getProba('1') || 0) * 100" color="primary"></mat-progress-bar>
                      <span class="value">{{ getProba('1')! | percent:'1.1-2' }}</span>
                    </div>
                  </div>
                </div>

                <mat-expansion-panel class="json-panel">
                  <mat-expansion-panel-header>
                    <mat-panel-title>Données brutes</mat-panel-title>
                  </mat-expansion-panel-header>
                  <pre class="json-dump">{{ { result: p } | json }}</pre>
                </mat-expansion-panel>

              </mat-card-content>
            </mat-card>
          </div>
        }
      </div>
    </div>
  </main>

  <footer class="app-footer">
    <div class="footer-container">
      <div class="footer-left">
        <span class="copyright">Webapp d'appel aux API de modèles de classification sur Dataiku</span>
        <span class="powered-by">
          Projet du cours Exploration avancée des données et Intelligence décisionnelle au 
          <span class="highlight">MSc BA MSI - HES-SO</span>
        </span>
      </div>

      <div class="footer-links">
        <a href="https://github.com/francoisbrouchoud/phishing-ui-form" mat-button color="primary" target="_blank">
          Repo GitHub
        </a>
      </div>
    </div>
  </footer>
</div>
